(()=>{"use strict";const t={refreshRate:3e3,duration:3,samplingDuration:10,samplingInterval:5,bucketSize:5,disableCountdown:5,graphOptions:{legend:{position:"none"},titleTextStyle:{color:"white"},hAxis:{format:"HH:mm:ss",textStyle:{color:"#999999"},gridlines:{color:"none"}},vAxis:{textStyle:{color:"#999999"},gridlines:{color:"none"}},chartArea:{width:"80%",height:"75%"},backgroundColor:"none"}};function e(t){t.setAttribute("hidden","hidden")}function n(t){t.removeAttribute("hidden")}function a(t){const{chartDom:e}=t;t.googleChart=new google.visualization.ColumnChart(e)}function o(t){const{chartDom:e}=t;t.googleChart=new google.visualization.AreaChart(e)}function r({chartDom:t}){t.innerHTML=""}function i(t,{googleChart:e,options:n}){const a=google.visualization.arrayToDataTable(t);e.draw(a,n)}function c(t){let e;return fetch(t).then((t=>(e=t.status,t.json()))).then((t=>{if(200!==e)throw t;return t}))}function l(t){return(e,n)=>function(t,e,n){return c(function(t,e,n){return`${t}?from=${encodeURIComponent(e)}&duration=${n}`}(`https://queue-qna.herokuapp.com${t}`,e,n))}(t,e,n)}const s=l("/stats/errors"),u=l("/stats/arrivals"),d=l("/stats/departures"),g=l("/stats/processing-times"),h=l("/stats/lengths");function m(e,n=t.bucketSize){return e-e%n}function p(e,n,a){const{bucketSize:o}=t,r=n.unix(),i=a.unix(),c={},l=[];for(let t=m(r);t<i;t+=o)c[t]=0,l.push(t);e.forEach((t=>{c[m(t)]+=1}));const s=[["Timestamp","Count"]];return l.forEach((t=>{s.push([new Date(1e3*t),c[t]])})),s}const f=e,y=n,C=e,b=n,v={"error-rate":{options:{...t.graphOptions,title:"errors/sec",colors:["#ff0000"]},createChart:a,clearChart:r,draw:i,payloadToData:function(t,e,n){return p(t.map((({timestamp:t})=>t)),e,n)},getPayload:s},"arrival-rate":{options:{...t.graphOptions,title:"arrivals/sec",colors:["#00ff00"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:u},"departure-rate":{options:{...t.graphOptions,title:"departure/sec",colors:["#0000ff"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:d},"average-processing-time":{options:{...t.graphOptions,title:"average processing time/sec",colors:["#FF00FF"]},createChart:o,clearChart:r,draw:i,payloadToData:function(t,e,n){const a=e.unix(),o=n.unix(),r={};t.forEach((({received_time:t,processing_time:e})=>{r[t]||(r[t]=[]),r[t].push(e)}));const i=[["Timestamp","Average"]];for(let t=a;t<o;t++)if(r[t]){const e=r[t],n=e.reduce(((t,e)=>t+e),0)/e.length;i.push([new Date(1e3*t),n])}else i.push([new Date(1e3*t),0]);return i},getPayload:g},"queue-length":{options:{...t.graphOptions,title:"sampled queue lengths",colors:["#FFFF00"]},createChart:o,clearChart:r,draw:i,payloadToData:function(t){const e=[["Timestamp","Average"]];return t.lengths.length&&t.is_sampling?[...e,...t.lengths.map((({timestamp:t,length:e})=>[new Date(1e3*t),e]))]:[...e,[0,0]]},getPayload:h},"waiting-time-stats":{options:{colors:["#006400"]},panels:[{key:"mean",label:"Average Waiting Time"},{key:"median",label:"Median Waiting Time"},{key:"max",label:"Max Waiting Time"},{key:"min",label:"Min Waiting Time"}],createChart:function(t){const{panels:e,isDrawn:n,chartDom:a}=t;n||(e.forEach((t=>{const{label:e}=t,n=document.createElement("div");n.classList.add("panel"),a.appendChild(n);const o=document.createElement("p");o.classList.add("label"),o.innerHTML=e,n.appendChild(o);const r=document.createElement("p");r.classList.add("count"),n.appendChild(r),t.countDom=r})),t.isDrawn=!0)},clearChart:()=>{},draw:function(t,{panels:e,options:n}){e.forEach((({countDom:e,key:a})=>{(t[a]||0===t[a])&&(e.innerHTML=t[a].toFixed(1),[e.parentNode.style.backgroundColor]=n.colors)}))},payloadToData:function(t){const e=dayjs().unix(),n=t.map((({arrival:t})=>Math.max(0,e-t))).sort(((t,e)=>t-e));var a;return{mean:(a=n).length?a.reduce(((t,e)=>t+e),0)/a.length:0,median:function(t){if(!t.length)return 0;const e=Math.floor(t.length/2);return t.length%2?t[e]:(t[e-1]+t[e])/2}(n),max:n[n.length-1]||0,min:n[0]||0}},getPayload:()=>c("https://queue-qna.herokuapp.com/queue")}};function D(e){const n=v[e];if(!n.canDrawChart())return;const{getPayload:a,payloadToData:o,draw:r,loadingAnimation:i,warningIcon:c}=n,{duration:l}=t,[s,u,d]=function(t){const e=dayjs().utc(),n=e.subtract(t,"minute"),a=n.format("YYYY-MM-DDTHH:mm:ss");return[e,n,a]}(l);b(i),a(d,l).then((t=>{if(!n.canDrawChart())return;f(c);const e=o(t,u,s);r(e,n)})).catch((t=>{y(c),console.error(t)})).finally((()=>{C(i)}))}let E,w;function L(e){clearInterval(E),E=setInterval((()=>{e.forEach((t=>{D(t)}))}),t.refreshRate)}function T(t,a){const o=document.getElementById("chart-containers");t.forEach((t=>{const r=a[t],i=r.containerDom,c=i.querySelector(".minimize-icon"),l=i.querySelector(".maximize-icon"),s=r.canDrawChart;r.canDrawChart=()=>s()&&function(t){return!w||w===t}(t),c.addEventListener("click",(()=>{w="",r.clearChart(a[t]),i.classList.toggle("full-screen-chart",!1),o.classList.toggle("normal",!0),o.classList.toggle("full-screen",!1),e(c),n(l),r.createChart(a[t]),D(t)})),l.addEventListener("click",(()=>{!function(t){w=t}(t),i.classList.toggle("full-screen-chart",!0),o.classList.toggle("normal",!1),o.classList.toggle("full-screen",!0),e(l),n(c),D(t)}))}))}function k(t,e){t.addEventListener("dragover",(t=>{t.preventDefault(),t.dataTransfer.dropEffect="move"})),t.addEventListener("drop",(n=>{n.preventDefault();const a=n.dataTransfer.getData("text/plain"),o=e[a].containerDom;t.parentNode.insertBefore(o,t)}))}function x(t,e){const n=document.getElementById("chart-containers");k(document.getElementById("drop-zone"),e),t.forEach((t=>{const a=e[t].containerDom;a.setAttribute("draggable",!0),a.addEventListener("dragstart",(e=>{n.classList.add("dragging"),e.dataTransfer.setData("text/plain",t),e.dataTransfer.dropEffect="move"})),a.addEventListener("dragend",(()=>{n.classList.remove("dragging")})),k(a,e)}))}Object.keys(v).forEach((t=>{v[t].canDrawChart=()=>!0}));const I=[{label:"Stop Timer (min)",initial:t.disableCountdown,type:"number",onChange:e=>{t.disableCountdown=e}},{label:"Refresh Rate (ms)",initial:t.refreshRate,type:"number",onChange:(e,n,a)=>{t.refreshRate=e,L(n)}},{label:"Duration (min)",initial:t.duration,type:"number",onChange:e=>{t.duration=e}},{label:"Bucket Size (sec)",initial:t.bucketSize,type:"number",onChange:e=>{t.bucketSize=parseFloat(e)}},{label:"Sampling Duration (min)",initial:t.samplingDuration,type:"number",onChange:e=>{t.samplingDuration=parseFloat(e)}},{label:"Sampling Interval (sec)",initial:t.samplingInterval,type:"number",onChange:e=>{t.samplingInterval=parseFloat(e)}},{label:"Start sampling length",title:"Start",type:"button",onClick:()=>function(t,e){return fetch(`https://queue-qna.herokuapp.com/stats/sample-length?interval=${t}&duration=${e}`,{method:"PUT"}).catch((t=>alert(t)))}(t.samplingInterval,t.samplingDuration)}];function S(t,e){const n=document.getElementById("config-container");t.forEach((t=>{I.push(function(t,e){return{label:`${t} color`,type:"color",initial:e.options.colors[0]||"black",onChange:n=>{e.options.colors=[n],D(t)}}}(t,e[t]))})),I.forEach((({label:a,type:o,...r})=>{let i;if("button"===o){const{title:t,onClick:e}=r;i=document.createElement("button"),i.innerHTML=t,i.addEventListener("click",e)}else{const{onChange:n,initial:a}=r;i=document.createElement("input"),i.setAttribute("type",o),i.value=a,i.addEventListener("focusout",(()=>{n(i.value,t,e)}))}const c=document.createElement("label");c.innerHTML=a;const l=document.createElement("div");l.classList.add("config"),l.appendChild(c),l.appendChild(i),n.appendChild(l)}));let a=!0;document.getElementById("toggle-config").addEventListener("click",(()=>{n.classList.toggle("hidden",!a),a=!a}))}let q,A=!1;function M(t,e){const n=dayjs().unix();if(n>e)A=!0;else{const a=e-n;t&&(t.innerHTML=`⏳${a}`)}}function z(e){q&&clearInterval(q),A=!1;const n=dayjs().add(t.disableCountdown,"minute").unix();M(e,n),q=setInterval((()=>{M(e,n)}),1e3)}function F(t,e){!function(t,e){t.forEach((t=>{const n=e[t],a=n.canDrawChart;n.canDrawChart=()=>!A&&a()}))}(t,e);const n=document.getElementById("timer");n.addEventListener("click",(()=>{z(n)})),z(n)}google.charts.setOnLoadCallback((function(){!function(t){const e=Object.keys(v);e.forEach((t=>{const e=v[t],n=document.getElementById(t);e.containerDom=n,e.chartDom=n.querySelector(".chart"),e.loadingAnimation=n.querySelector(".loading-icon"),e.warningIcon=n.querySelector(".warning-icon"),e.createChart(e),D(t)})),t.forEach((t=>{t(e,v)}))}([L,T,x,S,F])}))})();